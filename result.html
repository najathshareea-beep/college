<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annual Result - Darunnajath College</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body {font-family:'Poppins',sans-serif;background:linear-gradient(-45deg,#ee7752,#e73c7e,#23a6d5,#23d5ab);background-size:400% 400%;animation:g 15s ease infinite;min-height:100vh;padding:20px}
    @keyframes g{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .card{background:rgba(255,255,255,.97);border-radius:25px;padding:3rem;max-width:560px;margin:40px auto;box-shadow:0 25px 50px rgba(0,0,0,.3);text-align:center}
    .btn-big{background:linear-gradient(135deg,#667eea,#764ba2);border:none;border-radius:15px;padding:1.3rem;color:white;font-size:1.2rem;width:100%}
    .btn-big:hover{transform:translateY(-5px);box-shadow:0 20px 40px rgba(0,0,0,.4)}
    .result-card{background:white;border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.2);margin:20px auto;max-width:960px}
    .header{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:white;padding:30px;text-align:center}
    .header img{width:80px;height:80px;border-radius:15px;border:4px solid rgba(255,255,255,.4)}
    table{font-size:.95rem}
    .grade-pass{background:#10b981;color:white;padding:4px 10px;border-radius:8px}
    .grade-fail{background:#ef4444;color:white;padding:4px 10px;border-radius:8px}
    .status-pass{background:#dcfce7;color:#166534;padding:5px 12px;border-radius:20px}
    .status-fail{background:#fecaca;color:#991b1b;padding:5px 12px;border-radius:20px}
    .loader{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);display:none;justify-content:center;align-items:center;z-index:9999}
    .spinner{width:70px;height:70px;border:8px solid #f3f3f3;border-top:8px solid #2563eb;border-radius:50%;animation:s 1s linear infinite}
    @keyframes s{to{transform:rotate(360deg)}}
    .error-box{background:#fee;border:2px solid #f99;border-radius:10px;padding:20px;margin:20px auto;max-width:500px}
  </style>
</head>
<body>

<div class="text-center text-white mb-4">
  <h1 style="font-size:3.8rem;font-weight:800;background:linear-gradient(to right,#fff,#f0f0f0);-webkit-background-clip:text;color:transparent">
    RESULT PORTAL
  </h1>
  <h2>DARUNNAJATH SHAREEATH AND ARTS COLLEGE</h2>
  <p>Punnakkad, Karuvarakundu</p>
</div>

<div class="card">
  <h3 style="color:#1e293b">Annual Examination Result 2025-26</h3>
  <p class="text-muted mt-3">Enter Registration Number & Date of Birth</p>
  <button class="btn-big mt-4" id="openForm">Check Result</button>
</div>

<div id="resultArea" class="container mt-5" style="display:none">
  <div id="PrintDiv"><div id="rs"></div></div>
</div>

<div class="loader" id="loader"><div class="spinner"></div></div>

<div class="modal fade" id="formModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Enter Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="myForm">
          <div class="mb-3">
            <label class="form-label">Registration Number</label>
            <input type="text" class="form-control form-control-lg" id="roll" placeholder="e.g. R1, R2, etc." required>
            <small class="text-muted">Enter exactly as in your admit card</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Date of Birth</label>
            <input type="date" class="form-control form-control-lg" id="dob" required>
            <small class="text-muted">Format: DD/MM/YYYY</small>
          </div>
          <button type="submit" class="btn btn-primary w-100 btn-lg">Get Result</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const ssid = '1ckOFULpgBLG13gWa_jKdy8LJwIUaxCRLN84tljLmCjo';
  const apikey = 'AIzaSyCEK79A2S8aL3XxQ4mruN1V95ifpDwXNLM';

  document.getElementById('openForm').onclick = () => new bootstrap.Modal(document.getElementById('formModal')).show();

  // Function to parse Google Sheets JSON response
  function parseGoogleSheetResponse(text) {
    try {
      // Remove the callback wrapper
      const jsonStr = text.replace(/^google\.visualization\.Query\.setResponse\(|\);$/g, '');
      return JSON.parse(jsonStr);
    } catch (error) {
      console.error('Error parsing JSON:', error);
      return null;
    }
  }

  // Function to format date for comparison
  function formatDateForComparison(dateString) {
    if (!dateString) return '';
    
    // If it's already in YYYY-MM-DD format
    if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
      return dateString;
    }
    
    // Try to parse as Date object
    try {
      const date = new Date(dateString);
      if (!isNaN(date.getTime())) {
        return date.toISOString().split('T')[0];
      }
    } catch (e) {
      console.warn('Date parsing error:', e);
    }
    
    return '';
  }

  document.getElementById('myForm').onsubmit = async e => {
    e.preventDefault();
    const inputRoll = document.getElementById('roll').value.trim();
    const inputDob = document.getElementById('dob').value;
    
    // Basic validation
    if (!inputRoll || !inputDob) {
      alert('Please enter both Registration Number and Date of Birth');
      return;
    }
    
    document.getElementById('loader').style.display = 'flex';
    document.getElementById('rs').innerHTML = '';
    document.getElementById('resultArea').style.display = 'none';

    try {
      // First, get list of sheets
      const sheetsRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${ssid}?key=${apikey}`);
      if (!sheetsRes.ok) {
        throw new Error(`Failed to fetch sheet list: ${sheetsRes.status}`);
      }
      
      const sheetsData = await sheetsRes.json();
      const sheetNames = sheetsData.sheets.map(s => s.properties.title).filter(n => n !== 'HOME');
      
      if (sheetNames.length === 0) {
        throw new Error('No data sheets found in the spreadsheet');
      }

      let found = false;
      let errorMessage = 'Registration number not found';
      
      // Search through each sheet
      for (const sheet of sheetNames) {
        try {
          const url = `https://docs.google.com/spreadsheets/d/${ssid}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}`;
          const res = await fetch(url);
          
          if (!res.ok) {
            console.warn(`Failed to fetch sheet "${sheet}": ${res.status}`);
            continue;
          }
          
          const text = await res.text();
          const json = parseGoogleSheetResponse(text);
          
          if (!json || !json.table || !json.table.rows) {
            console.warn(`Invalid data format in sheet "${sheet}"`);
            continue;
          }
          
          const rows = json.table.rows;
          
          // Start from row 2 (index 2) to skip headers
          for (let i = 2; i < rows.length; i++) {
            const cells = rows[i].c;
            
            if (!cells || cells.length < 3) continue;
            
            // Get registration number from first column
            const sheetRoll = cells[0] ? (cells[0].v || cells[0].f || '').toString().trim() : '';
            
            if (sheetRoll.toUpperCase() !== inputRoll.toUpperCase()) {
              continue;
            }
            
            // Found matching registration number, now check DOB
            const sheetDobRaw = cells[1] ? (cells[1].v || cells[1].f || '') : '';
            const sheetDob = formatDateForComparison(sheetDobRaw);
            const formattedInputDob = formatDateForComparison(inputDob);
            
            if (sheetDob && formattedInputDob && sheetDob !== formattedInputDob) {
              document.getElementById('rs').innerHTML = `
                <div class="error-box text-center">
                  <h3 class="text-danger"><i class="fas fa-exclamation-triangle"></i> Invalid Date of Birth</h3>
                  <p class="mb-3">The Date of Birth does not match our records.</p>
                  <button onclick="location.reload()" class="btn btn-warning mt-2">Try Again</button>
                </div>`;
              document.getElementById('resultArea').style.display = 'block';
              document.getElementById('loader').style.display = 'none';
              return;
            }
            
            // If we reach here, registration and DOB match
            found = true;
            
            // Extract student data
            const name = cells[2] ? (cells[2].v || cells[2].f || 'N/A').toString() : 'N/A';
            const total = cells[3] ? parseFloat(cells[3].v || cells[3].f || 0) : 0;
            const perc = cells[4] ? parseFloat(cells[4].v || cells[4].f || 0).toFixed(2) : '0.00';
            const rank = cells[5] ? (cells[5].v || cells[5].f || '-').toString() : '-';
            const grade = cells[7] ? (cells[7].v || cells[7].f || '-').toString() : '-';
            
            // Get subject headers (assuming they start from column 8)
            const subjectHeaders = rows[1] ? rows[1].c.slice(8) || [] : [];
            const maxMarksRow = rows[0] ? rows[0].c.slice(8) || [] : [];
            const obtainedMarks = cells.slice(8) || [];
            
            let subjectRowsHtml = '';
            let failedSubjects = [];
            let subjectCount = 1;
            
            // Generate subject rows
            for (let j = 0; j < subjectHeaders.length; j++) {
              if (!subjectHeaders[j] || !subjectHeaders[j].v) continue;
              
              const subject = subjectHeaders[j].v;
              const maxMark = maxMarksRow[j] ? parseFloat(maxMarksRow[j].v || 50) : 50;
              const obtainedCell = obtainedMarks[j];
              let obtained = 'A'; // Default to absent
              
              if (obtainedCell) {
                obtained = obtainedCell.v !== undefined ? obtainedCell.v : 
                          obtainedCell.f !== undefined ? obtainedCell.f : 'A';
              }
              
              // Calculate grade
              let gradeSymbol = 'D';
              if (obtained !== 'A' && obtained !== 'a') {
                const numericObtained = parseFloat(obtained);
                if (!isNaN(numericObtained)) {
                  const percentage = (numericObtained / maxMark) * 100;
                  
                  if (percentage >= 90) gradeSymbol = 'A+';
                  else if (percentage >= 80) gradeSymbol = 'A';
                  else if (percentage >= 70) gradeSymbol = 'B+';
                  else if (percentage >= 60) gradeSymbol = 'B';
                  else if (percentage >= 50) gradeSymbol = 'C';
                  else gradeSymbol = 'D';
                }
              }
              
              if (gradeSymbol === 'D') {
                failedSubjects.push(subject);
              }
              
              subjectRowsHtml += `
                <tr>
                  <td>${subjectCount++}</td>
                  <td>${subject}</td>
                  <td>${maxMark}</td>
                  <td>${obtained}</td>
                  <td class="${gradeSymbol === 'D' ? 'grade-fail' : 'grade-pass'}">${gradeSymbol}</td>
                  <td><span class="status-${gradeSymbol === 'D' ? 'fail' : 'pass'}">${gradeSymbol === 'D' ? 'Fail' : 'Pass'}</span></td>
                </tr>`;
            }
            
            const overallStatus = failedSubjects.length > 0 ? 'FAILED' : 'PASSED';
            const currentTime = new Date().toLocaleString('en-GB', {
              day: '2-digit',
              month: 'short',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            
            // Format DOB for display
            const displayDob = inputDob.split('-').reverse().join('-');
            
            // Generate result HTML
            document.getElementById('rs').innerHTML = `
              <div class="text-center mb-4">
                <button onclick="location.reload()" class="btn btn-warning">Check Another Result</button>
                <button onclick="window.print()" class="btn btn-success ms-3">Print Result</button>
              </div>
              <div class="result-card">
                <div class="header">
                  <div class="d-flex justify-content-center align-items-center gap-4">
                    <img src="https://i.postimg.cc/rmS5jXXX/COLLEGE-LOGO.png" alt="College Logo">
                    <div class="text-start text-white">
                      <h1>DARUNNAJATH SHAREEATH COLLEGE</h1>
                      <h2>Karuvarakundu</h2>
                      <div style="background:rgba(255,255,255,.3);padding:8px 20px;border-radius:30px;display:inline-block;margin-top:10px">
                        Annual Examination 2025-26
                      </div>
                    </div>
                  </div>
                </div>
                <div class="p-4">
                  <h4 class="text-primary mb-4">Student Information</h4>
                  <div class="row text-center mb-4">
                    <div class="col-6 col-md-3"><strong>Reg No:</strong><br>${inputRoll.toUpperCase()}</div>
                    <div class="col-6 col-md-3"><strong>Name:</strong><br>${name}</div>
                    <div class="col-6 col-md-3"><strong>Class:</strong><br>${sheet}</div>
                    <div class="col-6 col-md-3"><strong>DOB:</strong><br>${displayDob}</div>
                  </div>
                  
                  <h4 class="text-primary mb-3">Subject-wise Performance</h4>
                  <div class="table-responsive">
                    <table class="table table-bordered">
                      <thead class="table-primary">
                        <tr>
                          <th>#</th>
                          <th>Subject</th>
                          <th>Max Marks</th>
                          <th>Obtained</th>
                          <th>Grade</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>${subjectRowsHtml}</tbody>
                    </table>
                  </div>
                  
                  <div class="mt-4 text-center ${overallStatus === 'FAILED' ? 'text-danger' : 'text-success'} fs-3">
                    <strong>RESULT: ${overallStatus}</strong>
                  </div>
                  
                  ${failedSubjects.length > 0 ? 
                    `<div class="alert alert-danger text-center mt-3">
                      <strong>Failed in:</strong> ${failedSubjects.join(', ')}
                    </div>` : 
                    `<div class="alert alert-success text-center mt-3">
                      <strong>Congratulations! You have passed all subjects.</strong>
                    </div>`
                  }
                  
                  <div class="row text-center mt-4">
                    <div class="col-6 col-md-3"><strong>Total Marks:</strong><br>${total}</div>
                    <div class="col-6 col-md-3"><strong>Percentage:</strong><br>${perc}%</div>
                    <div class="col-6 col-md-3"><strong>Overall Grade:</strong><br>${grade}</div>
                    <div class="col-6 col-md-3"><strong>Class Rank:</strong><br>${rank}</div>
                  </div>
                  
                  <div class="text-center text-muted mt-4">
                    <small>Result generated on: ${currentTime}</small>
                  </div>
                </div>
              </div>`;
              
            break; // Exit row loop
          }
          
          if (found) break; // Exit sheet loop
          
        } catch (sheetError) {
          console.error(`Error processing sheet "${sheet}":`, sheetError);
          errorMessage = `Error processing data: ${sheetError.message}`;
        }
      }
      
      if (!found) {
        throw new Error(errorMessage);
      }
      
      document.getElementById('resultArea').style.display = 'block';
      bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();
      
    } catch (error) {
      console.error('Main error:', error);
      document.getElementById('rs').innerHTML = `
        <div class="error-box text-center">
          <h3 class="text-danger"><i class="fas fa-exclamation-circle"></i> ${error.message}</h3>
          <p class="mb-3">Please check your registration number and try again.</p>
          <p><small>If the problem persists, contact the examination department.</small></p>
          <button onclick="location.reload()" class="btn btn-warning mt-2">Try Again</button>
          <button onclick="new bootstrap.Modal(document.getElementById('formModal')).show()" class="btn btn-secondary mt-2 ms-2">Re-enter Details</button>
        </div>`;
      document.getElementById('resultArea').style.display = 'block';
    } finally {
      document.getElementById('loader').style.display = 'none';
    }
  };
</script>
</body>
</html>
