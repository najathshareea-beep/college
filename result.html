<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Results - DARUNNAJATH SHAREEATH AND ARTS COLLEGE</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #2563eb; --primary-dark: #1d4ed8; --secondary: #f59e0b; --success: #10b981; --danger: #ef4444; --light: #f8fafc; --dark: #1e293b; --gray: #64748b; --border: #e2e8f0; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { min-height: 100vh; font-family: 'Poppins', sans-serif; background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); background-size: 400% 400%; animation: gradientBG 15s ease infinite; color: #fff; padding: 20px; }
    @keyframes gradientBG { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    .header-container { text-align: center; margin-bottom: 3rem; }
    .main-heading { font-size: 3.8rem; font-weight: 800; background: linear-gradient(to right, #fff, #f0f0f0); -webkit-background-clip: text; color: transparent; }
    .result-box { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 25px; padding: 3rem; max-width: 550px; margin: 0 auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3); text-align: center; }
    .result-btn { background: linear-gradient(135deg, #667eea, #764ba2); border: none; border-radius: 15px; padding: 1.2rem; color: white; font-weight: 600; font-size: 1.1rem; width: 100%; }
    .result-btn:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(102,126,234,0.4); }
    .result-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin: 20px auto; max-width: 950px; }
    .result-header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 25px; text-align: center; }
    .college-logo { width: 70px; height: 70px; border-radius: 12px; border: 4px solid rgba(255,255,255,0.4); }
    .modern-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95rem; }
    .modern-table th { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 12px; }
    .modern-table td { padding: 10px; border-bottom: 1px solid var(--border); }
    .grade-pass { background: var(--success); color: white; padding: 4px 10px; border-radius: 8px; }
    .grade-fail { background: var(--danger); color: white; padding: 4px 10px; border-radius: 8px; }
    .status-pass { background: #dcfce7; color: #166534; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; }
    .status-fail { background: #fecaca; color: #991b1b; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; }
    .action-buttons { text-align: center; margin: 25px 0; }
    .btn-secondary { background: var(--secondary); color: white; border: none; padding: 12px 25px; border-radius: 10px; margin: 0 8px; }
    .error-message { text-align: center; padding: 50px; background: white; border-radius: 15px; margin: 30px auto; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .loader-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 9999; }
    .modern-loader { width: 70px; height: 70px; border: 6px solid #f3f3f3; border-top: 6px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div class="header-container">
    <h1 class="main-heading">RESULT PORTAL</h1>
    <div style="font-size:1.8rem; font-weight:600;">DARUNNAJATH SHAREEATH AND ARTS COLLEGE</div>
    <div style="font-size:1.2rem; opacity:0.9;">Punnakkad, Karuvarakundu</div>
  </div>

  <div class="result-box">
    <h2 style="color:#1e293b; margin-bottom:20px;">Annual Examination Result 2025-26</h2>
    <p style="margin-bottom:25px; color:#555;">Click below to check your result</p>
    <button class="result-btn" id="finalResultBtn">
      <i class="fa-solid fa-book-open-reader"></i> Check Annual Result
    </button>
  </div>

  <div class="container mt-5" id="resultContainer" style="display:none;">
    <div id="PrintDiv"><div id="rs"></div></div>
  </div>

  <div class="loader-container" id="lod">
    <div><div class="modern-loader"></div><p style="color:white; margin-top:20px;">Loading your result...</p></div>
  </div>

  <div class="modal fade" id="inputModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background: var(--primary); color:white;">
          <h5 class="modal-title"><i class="fas fa-id-card"></i> Enter Your Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="resultForm">
            <div class="mb-3">
              <label class="form-label"><i class="fas fa-user-graduate"></i> Registration Number</label>
              <input type="text" class="form-control form-control-lg" id="roll" placeholder="e.g. 1001" required>
            </div>
            <div class="mb-3">
              <label class="form-label"><i class="fas fa-calendar"></i> Date of Birth</label>
              <input type="date" class="form-control form-control-lg" id="dob" required>
            </div>
            <button type="submit" class="btn btn-primary w-100 btn-lg"><i class="fas fa-search"></i> Get Result</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const ssid = '1ckOFULpgBLG13gWa_jKdy8LJwIUaxCRLN84tljLmCjo';
    const apikey = 'AIzaSyCEK79A2S8aL3XxQ4mruN1V95ifpDwXNLM';  // Your key is here

    document.getElementById('finalResultBtn').onclick = () => {
      new bootstrap.Modal(document.getElementById('inputModal')).show();
    };

    document.getElementById('resultForm').onsubmit = async (e) => {
      e.preventDefault();
      const roll = document.getElementById('roll').value.trim();
      const dobInput = document.getElementById('dob').value;
      document.getElementById('lod').style.display = 'flex';
      document.getElementById('rs').innerHTML = '';

      try {
        const homeUrl = `https://docs.google.com/spreadsheets/d/${ssid}/gviz/tq?tqx=out:json&sheet=HOME`;
        const homeText = await (await fetch(homeUrl)).text();
        const homeJson = JSON.parse(homeText.replace(/.*google.visualization.Query.setResponse\(/s, '').slice(0, -2));
        const homeRows = homeJson.table.rows;

        const ta = homeRows[0]?.c[1]?.v || 'DARUNNAJATH COLLEGE';
        const ti = homeRows[1]?.c[1]?.v || 'DARUNNAJATH SHAREEATH AND ARTS COLLEGE';
        const tp = homeRows[2]?.c[1]?.v || 'Karuvarakundu';
        const tt = homeRows[3]?.c[1]?.v || 'Annual Examination 2025-26';

        const grading = [];
        for (let i = 1; i < homeRows.length; i++) {
          const r = homeRows[i].c;
          if (r && r[3] && r[4] && r[5]) grading.push([r[3].v, r[4].v, r[5].v]);
        }

        const sheetsRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${ssid}?key=${apikey}`);
        const data = await sheetsRes.json();
        const sheetNames = data.sheets.map(s => s.properties.title).filter(t => /^\d+[A-Z]$/.test(t));

        let found = false;
        for (const sheet of sheetNames) {
          const url = `https://docs.google.com/spreadsheets/d/${ssid}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}&tq=SELECT%20*%20WHERE%20A%20%3D%20%27${roll}%27`;
          const text = await (await fetch(url)).text();
          const json = JSON.parse(text.replace(/.*google.visualization.Query.setResponse\(/s, '').slice(0, -2));
          const rows = json.table.rows || [];
          if (rows.length === 0) continue;

          const row = rows[0].c;
          const storedDOB = row[1] ? new Date(row[1].v) : null;
          const inputDOB = new Date(dobInput);
          if (!storedDOB || storedDOB.toISOString().slice(0,10) !== inputDOB.toISOString().slice(0,10)) {
            throw new Error("Invalid Date of Birth");
          }

          const headerUrl = `https://docs.google.com/spreadsheets/d/${ssid}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}&tq=SELECT%20*%20LIMIT%202`;
          const htext = await (await fetch(headerUrl)).text();
          const hjson = JSON.parse(htext.replace(/.*google.visualization.Query.setResponse\(/s, '').slice(0, -2));
          const [headerRow, subjectRow] = hjson.table.rows.map(r => r.c);

          const className = headerRow[1]?.v || '';
          const totalMax = headerRow[6]?.v || 0;
          const name = row[2]?.v || '';
          const totalObtained = row[3]?.v || 0;
          const percentage = parseFloat(row[4]?.v || 0).toFixed(2);
          const rank = row[5]?.v || '';
          const overallGrade = row[7]?.v || '';

          const subjectNames = subjectRow.slice(8, 37).map(c => c?.v || '');
          const maxMarks = headerRow.slice(8, 37).map(c => c?.v || 0);
          const obtainedMarks = row.slice(8, 37).map(c => c?.v ?? c?.f ?? '');

          let tableRows = '';
          let failed = [];
          let serial = 1;

          for (let i = 0; i < subjectNames.length; i++) {
            if (!subjectNames[i]) continue;
            const obt = obtainedMarks[i];
            const max = maxMarks[i];
            let grade = 'N/A';
            if (obt !== 'A') {
              const perc = (obt / max) * 100;
              for (const [low, high, g] of grading) {
                if (perc >= low && perc <= high) { grade = g; break; }
              }
            } else grade = 'D';

            if (grade === 'D') failed.push(subjectNames[i]);
            tableRows += `<tr><td>${serial++}.</td><td>${subjectNames[i]}</td><td>${max}</td><td>${obt}</td><td class="${grade==='D'?'grade-fail':'grade-pass'}">${grade}</td><td><span class="status-${grade==='D'?'fail':'pass'}">${grade==='D'?'Fail':'Pass'}</span></td></tr>`;
          }

          const status = failed.length > 0 ? 'FAILED' : 'PASSED';
          const statusClass = failed.length > 0 ? 'result-failed' : 'result-passed';
          const failMsg = failed.length > 0 ? `Failed in: ${failed.join(', ')}` : 'Passed in all subjects';
          const now = new Date().toLocaleString('en-GB', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });

          document.getElementById('rs').innerHTML = `
            <div class="action-buttons">
              <button onclick="showAnother()" class="btn-secondary"><i class="fas fa-arrow-left"></i> Check Another</button>
              <button onclick="window.print()" class="btn-secondary"><i class="fas fa-print"></i> Print</button>
            </div>
            <div class="result-card">
              <div class="result-header">
                <div style="display:flex; align-items:center; justify-content:center; gap:20px;">
                  <img src="https://i.postimg.cc/rmS5jXXX/COLLEGE-LOGO.png" class="college-logo">
                  <div style="text-align:left;">
                    <h1>${ta}</h1>
                    <h2>${ti}</h2>
                    <h3>${tp}</h3>
                    <div class="exam-title">${tt}</div>
                  </div>
                </div>
              </div>
              <div class="student-profile">
                <div class="section-header"><h3>Student Information</h3></div>
                <div class="profile-grid">
                  <div class="profile-item"><label>Reg No:</label><span>${roll}</span></div>
                  <div class="profile-item"><label>Name:</label><span>${name}</span></div>
                  <div class="profile-item"><label>Class:</label><span>${className}</span></div>
                  <div class="profile-item"><label>DOB:</label><span>${dobInput.split('-').reverse().join('-')}</span></div>
                </div>
              </div>
              <div class="results-section">
                <div class="section-header"><h3>Subject-wise Performance</h3></div>
                <table class="modern-table"><thead><tr><th>#</th><th>Subject</th><th>Max</th><th>Obtained</th><th>Grade</th><th>Status</th></tr></thead><tbody>${tableRows}</tbody></table>
              </div>
              <div class="performance-summary">
                <div class="section-header"><h3>Overall Performance</h3></div>
                <div class="summary-grid">
                  <div class="summary-card"><div class="summary-icon" style="background:#3b82f6;"><i class="fas fa-star"></i></div><h4>${totalObtained}</h4><p>Total Score</p><small>out of ${totalMax}</small></div>
                  <div class="summary-card"><div class="summary-icon" style="background:#10b981;"><i class="fas fa-percentage"></i></div><h4>${percentage}%</h4><p>Percentage</p></div>
                  <div class="summary-card"><div class="summary-icon" style="background:#f59e0b;"><i class="fas fa-medal"></i></div><h4>${overallGrade}</h4><p>Overall Grade</p></div>
                  <div class="summary-card"><div class="summary-icon" style="background:#8b5cf6;"><i class="fas fa-trophy"></i></div><h4>${rank}</h4><p>Rank</p></div>
                </div>
                <div class="final-result ${statusClass}">
                  <div class="result-badge"><i class="fas fa-${status==='PASSED'?'check':'times'}"></i> ${status}</div>
                  <p>${failMsg}</p>
                </div>
                <div style="text-align:center; padding:15px; color:#666; font-size:0.9rem;">
                  Generated: ${now} | Official Result
                </div>
              </div>
            </div>
          `;

          found = true;
          break;
        }

        if (!found) throw new Error("Registration number not found");

        document.getElementById('resultContainer').style.display = 'block';
        bootstrap.Modal.getInstance(document.getElementById('inputModal')).hide();

      } catch (err) {
        document.getElementById('rs').innerHTML = `
          <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>${err.message.includes('Date') ? 'Invalid Date of Birth' : err.message.includes('not found') ? 'Registration Number Not Found' : 'Something went wrong'}</h3>
            <p>Please check your details and try again.</p>
            <button onclick="showAnother()" class="btn-secondary">Try Again</button>
          </div>`;
        document.getElementById('resultContainer').style.display = 'block';
      } finally {
        document.getElementById('lod').style.display = 'none';
      }
    };

    function showAnother() {
      document.getElementById('resultContainer').style.display = 'none';
      document.getElementById('rs').innerHTML = '';
      new bootstrap.Modal(document.getElementById('inputModal')).show();
    }
  </script>
</body>
</html>
