<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Result Portal Debug</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {padding:20px;font-family:Arial,sans-serif}
    .debug-info {background:#f8f9fa;border:1px solid #dee2e6;border-radius:5px;padding:15px;margin:10px 0;font-family:monospace;font-size:12px;max-height:300px;overflow-y:auto}
    .debug-title {background:#6c757d;color:white;padding:5px 10px;border-radius:3px;margin-bottom:10px}
    pre {background:#e9ecef;padding:10px;border-radius:5px;overflow-x:auto}
  </style>
</head>
<body>
  <div class="container">
    <h2>Debug Result Portal</h2>
    <p>This will test the connection to your Google Sheet and show what data is available.</p>
    
    <div class="card mt-4">
      <div class="card-header bg-primary text-white">
        Test Connection
      </div>
      <div class="card-body">
        <button id="testBtn" class="btn btn-success">Test Google Sheets Connection</button>
        <button id="clearBtn" class="btn btn-secondary">Clear Log</button>
      </div>
    </div>
    
    <div id="debugOutput" class="mt-4">
      <!-- Debug info will appear here -->
    </div>
  </div>

  <script>
    const ssid = '1ckOFULpgBLG13gWa_jKdy8LJwIUaxCRLN84tljLmCjo';
    const apikey = 'AIzaSyCEK79A2S8aL3XxQ4mruN1V95ifpDwXNLM';
    
    function addDebugInfo(title, content) {
      const output = document.getElementById('debugOutput');
      const div = document.createElement('div');
      div.className = 'debug-info';
      div.innerHTML = `
        <div class="debug-title">${title}</div>
        <pre>${typeof content === 'object' ? JSON.stringify(content, null, 2) : content}</pre>
      `;
      output.appendChild(div);
    }
    
    async function testGoogleSheets() {
      document.getElementById('debugOutput').innerHTML = '';
      
      try {
        // Test 1: Check if we can access the spreadsheet
        addDebugInfo('Test 1: Fetching spreadsheet info...', 'Attempting to connect to Google Sheets...');
        
        const sheetsRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${ssid}?key=${apikey}`);
        
        if (!sheetsRes.ok) {
          const errorText = await sheetsRes.text();
          addDebugInfo('Error fetching spreadsheet', `Status: ${sheetsRes.status}\nResponse: ${errorText}`);
          throw new Error(`HTTP ${sheetsRes.status}: ${errorText}`);
        }
        
        const sheetsData = await sheetsRes.json();
        addDebugInfo('Spreadsheet Info', {
          title: sheetsData.properties?.title,
          sheetCount: sheetsData.sheets?.length,
          sheetNames: sheetsData.sheets?.map(s => s.properties.title)
        });
        
        // Test 2: Try to fetch data from each sheet
        const sheetNames = sheetsData.sheets.map(s => s.properties.title);
        
        for (const sheetName of sheetNames) {
          try {
            addDebugInfo(`Testing sheet: "${sheetName}"`, 'Fetching data...');
            
            const url = `https://docs.google.com/spreadsheets/d/${ssid}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
            const res = await fetch(url);
            
            if (!res.ok) {
              addDebugInfo(`Error fetching sheet "${sheetName}"`, `Status: ${res.status}`);
              continue;
            }
            
            const text = await res.text();
            addDebugInfo(`Raw response from "${sheetName}"`, text.substring(0, 1000) + (text.length > 1000 ? '...' : ''));
            
            // Try to parse the response
            try {
              // Remove the callback wrapper
              let jsonStr = text;
              if (text.startsWith('google.visualization.Query.setResponse(')) {
                jsonStr = text.substring(text.indexOf('({'), text.lastIndexOf('})') + 1);
              }
              
              const data = JSON.parse(jsonStr);
              addDebugInfo(`Parsed data from "${sheetName}"`, {
                hasTable: !!data.table,
                rowCount: data.table?.rows?.length || 0,
                firstFewRows: data.table?.rows?.slice(0, 3) || 'No rows'
              });
              
              // Show column headers if available
              if (data.table && data.table.cols) {
                addDebugInfo(`Column structure for "${sheetName}"`, 
                  data.table.cols.map((col, i) => `${i}: ${col.label || 'Column ' + i}`).join('\n'));
              }
              
              // Show first few data rows
              if (data.table && data.table.rows && data.table.rows.length > 0) {
                let sampleData = 'First 3 rows of data:\n\n';
                for (let i = 0; i < Math.min(3, data.table.rows.length); i++) {
                  const row = data.table.rows[i];
                  sampleData += `Row ${i}: `;
                  if (row.c) {
                    sampleData += row.c.map(cell => 
                      cell ? (cell.v !== undefined ? `"${cell.v}"` : cell.f ? `[formula: ${cell.f}]` : '[empty]') : '[null]'
                    ).join(' | ');
                  }
                  sampleData += '\n';
                }
                addDebugInfo(`Sample data from "${sheetName}"`, sampleData);
              }
              
            } catch (parseError) {
              addDebugInfo(`Parse error for "${sheetName}"`, parseError.message);
            }
            
          } catch (sheetError) {
            addDebugInfo(`Sheet error for "${sheetName}"`, sheetError.message);
          }
        }
        
        addDebugInfo('Test Complete', 'All tests finished. Check the logs above for issues.');
        
      } catch (error) {
        addDebugInfo('Critical Error', error.message + '\n\nStack: ' + error.stack);
      }
    }
    
    document.getElementById('testBtn').onclick = testGoogleSheets;
    document.getElementById('clearBtn').onclick = () => {
      document.getElementById('debugOutput').innerHTML = '';
    };
  </script>
</body>
</html>
