<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Result Portal - Simple</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-5">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h3>Result Checker - Simple Version</h3>
      </div>
      <div class="card-body">
        <form id="searchForm">
          <div class="mb-3">
            <label>Registration Number</label>
            <input type="text" class="form-control" id="roll" value="r2" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Search</button>
        </form>
        
        <div id="result" class="mt-4"></div>
      </div>
    </div>
  </div>

  <script>
    const SHEET_ID = '1ckOFULpgBLG13gWa_jKdy8LJwIUaxCRLN84tljLmCjo';
    
    // Try different sheet access methods
    async function fetchSheet(sheetName) {
      const urls = [
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`,
        `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0&sheet=${encodeURIComponent(sheetName)}`
      ];
      
      for (const url of urls) {
        try {
          const response = await fetch(url);
          if (response.ok) {
            const text = await response.text();
            console.log(`Success with URL: ${url}`);
            return text;
          }
        } catch (e) {
          console.log(`Failed with URL: ${url}`);
        }
      }
      return null;
    }
    
    // Simple CSV parsing
    function parseCSVSimple(csvText) {
      const rows = [];
      const lines = csvText.split('\n');
      
      for (const line of lines) {
        if (line.trim() === '') continue;
        
        // Simple split by comma (for testing)
        const cells = line.split(',').map(cell => {
          // Remove quotes if present
          return cell.replace(/^"|"$/g, '').trim();
        });
        
        rows.push(cells);
      }
      
      return rows;
    }
    
    // Search in specific sheets
    async function searchInSheet(sheetName, rollNumber) {
      try {
        console.log(`Searching in ${sheetName} for ${rollNumber}`);
        
        const csvText = await fetchSheet(sheetName);
        if (!csvText) {
          console.log(`Cannot access ${sheetName}`);
          return null;
        }
        
        const rows = parseCSVSimple(csvText);
        console.log(`${sheetName} has ${rows.length} rows`);
        
        // Show first few rows
        console.log('First 3 rows:');
        for (let i = 0; i < Math.min(3, rows.length); i++) {
          console.log(`Row ${i}:`, rows[i]);
        }
        
        // Search all rows
        for (let i = 2; i < rows.length; i++) {
          const row = rows[i];
          if (row.length > 0 && row[0]) {
            const cellValue = row[0].toString().trim();
            console.log(`Row ${i}, Col 0: "${cellValue}"`);
            
            if (cellValue.toLowerCase() === rollNumber.toLowerCase()) {
              console.log(`FOUND in ${sheetName} at row ${i}`);
              return {
                sheet: sheetName,
                row: i,
                data: row,
                allRows: rows
              };
            }
          }
        }
        
        console.log(`Not found in ${sheetName}`);
        return null;
        
      } catch (error) {
        console.error(`Error searching ${sheetName}:`, error);
        return null;
      }
    }
    
    document.getElementById('searchForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const roll = document.getElementById('roll').value.trim();
      document.getElementById('result').innerHTML = 'Searching... (check browser console for details)';
      
      console.clear();
      console.log('Starting search for:', roll);
      
      try {
        // Try specific sheets
        const sheets = ['8R', '2C', '1A', '3C', '4C', '5C'];
        let foundResult = null;
        
        for (const sheetName of sheets) {
          const result = await searchInSheet(sheetName, roll);
          if (result) {
            foundResult = result;
            break;
          }
        }
        
        if (foundResult) {
          const student = foundResult.data;
          document.getElementById('result').innerHTML = `
            <div class="alert alert-success">
              <h4>✓ Found in ${foundResult.sheet} sheet!</h4>
              <p><strong>Registration:</strong> ${student[0]}</p>
              <p><strong>Name:</strong> ${student[2] || 'N/A'}</p>
              <p><strong>Total Marks:</strong> ${student[3] || 'N/A'}</p>
              <p><strong>Percentage:</strong> ${student[4] || 'N/A'}%</p>
              <button onclick="location.reload()" class="btn btn-primary">Search Again</button>
            </div>
          `;
        } else {
          document.getElementById('result').innerHTML = `
            <div class="alert alert-danger">
              <h4>✗ Not Found</h4>
              <p>Registration <strong>${roll}</strong> not found in any sheet.</p>
              <p>Please check:</p>
              <ol>
                <li>Open browser console (F12) to see detailed search logs</li>
                <li>Check if sheet is shared publicly</li>
                <li>Try different registration numbers</li>
              </ol>
              <button onclick="location.reload()" class="btn btn-warning">Try Again</button>
            </div>
          `;
        }
        
      } catch (error) {
        document.getElementById('result').innerHTML = `
          <div class="alert alert-danger">
            <h4>Error</h4>
            <p>${error.message}</p>
          </div>
        `;
      }
    };
  </script>
</body>
</html>
