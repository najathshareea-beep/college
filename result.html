// ==================== MAIN FUNCTIONS ====================
function doGet(e) {
  // Check if it's an API request (has roll and dob parameters)
  if (e && e.parameter && e.parameter.roll && e.parameter.dob) {
    const result = processResultRequest(e);
    
    // Set proper CORS headers
    return ContentService.createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON)
      .addHeader('Access-Control-Allow-Origin', '*')
      .addHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
      .addHeader('Access-Control-Allow-Headers', 'Content-Type');
  } else {
    // Otherwise, show the main HTML page
    return HtmlService.createHtmlOutputFromFile('index')
      .setTitle("DARUNNAJATH SHAREEATH COLLEGE")
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  }
}

function doPost(e) {
  return doGet(e);
}

// ==================== EXAM RESULT API ====================
function processResultRequest(e) {
  try {
    // Get parameters from URL
    const rollVal = e.parameter.roll;
    let dobVal = e.parameter.dob;
    
    if (!rollVal || !dobVal) {
      return {
        result: 'error',
        message: 'Please provide both Roll Number and Date of Birth'
      };
    }
    
    // Connect to Google Sheet
    const sheetId = '1ckOFULpgBLG13gWa_jKdy8LJwIUaxCRLN84tljLmCjo';
    const spreadsheet = SpreadsheetApp.openById(sheetId);
    
    // Get all sheets
    var sheets = spreadsheet.getSheets();
    
    // Grading criteria
    const gradingCriteria = [
      [91, 100, 'A+'],
      [81, 90, 'A'],
      [71, 80, 'B+'],
      [61, 70, 'B'],
      [51, 60, 'C'],
      [41, 50, 'D'],
      [0, 40, 'F']
    ];
    
    // Loop through all sheets to find the student's roll number
    for (var sheetIndex = 0; sheetIndex < sheets.length; sheetIndex++) {
      var sheet = sheets[sheetIndex];
      var sheetName = sheet.getName();
      
      // Skip sheets that don't match your class name pattern
      if (!/^\d+[A-Z]$/.test(sheetName) && sheetName !== "8R" && sheetName !== "2C" && sheetName !== "3A" && sheetName !== "4A") {
        continue;
      }
      
      var lr = sheet.getLastRow();
      
      // Search for the roll number in the current sheet
      for (var i = 2; i <= lr; i++) {
        if (rollVal == sheet.getRange(i, 1).getValue()) {
          // Check if the date of birth matches
          var storedDOB = sheet.getRange(i, 2).getValue();
          
          // Format both dates for comparison
          var inputDOB = formatDateForComparison(dobVal);
          var sheetDOB = formatDateForComparison(storedDOB);
          
          if (inputDOB !== sheetDOB) {
            return {
              result: 'error',
              message: 'Invalid Date of Birth. Please check your date of birth and try again.'
            };
          }
          
          // Fetch student data
          var studentData = {
            rollNumber: rollVal,
            name: sheet.getRange(i, 3).getValue() || '',
            className: sheetName,
            dateOfBirth: formatDateForDisplay(storedDOB),
            totalScore: sheet.getRange(i, 4).getValue() || 0,
            percentage: parseFloat(sheet.getRange(i, 5).getValue() || 0).toFixed(2),
            rank: sheet.getRange(i, 6).getValue() || '',
            presents: sheet.getRange(i, 7).getValue() || 0,
            overallGrade: sheet.getRange(i, 8).getValue() || '',
            totalMaxScore: sheet.getRange(1, 7).getValue() || 0,
            totalMaxPresents: sheet.getRange(1, 4).getValue() || 0
          };
          
          // Fetch subject names from row 2
          var subjectNames = sheet.getRange(2, 9, 1, 29).getValues()[0];
          
          // Fetch subject scores for the student
          var subjectScores = sheet.getRange(i, 9, 1, 29).getValues()[0];
          
          // Prepare subject data
          var subjects = [];
          var failedSubjects = [];
          
          for (var j = 0; j < subjectNames.length; j++) {
            var subjectName = subjectNames[j];
            if (!subjectName || subjectName === "") continue;
            
            var maxScore = sheet.getRange(1, 9 + j).getValue() || 0;
            var obtainedScore = subjectScores[j] || 0;
            var subjectPercentage = maxScore > 0 ? (obtainedScore / maxScore) * 100 : 0;
            var grade = "N/A";
            
            // Determine grade
            if (obtainedScore === "A" || obtainedScore === "a") {
              grade = "F";
            } else if (obtainedScore === "" || obtainedScore === null) {
              grade = "N/A";
            } else {
              for (var k = 0; k < gradingCriteria.length; k++) {
                if (subjectPercentage >= gradingCriteria[k][0] && subjectPercentage <= gradingCriteria[k][1]) {
                  grade = gradingCriteria[k][2];
                  break;
                }
              }
            }
            
            var subject = {
              name: subjectName,
              maxScore: maxScore,
              obtainedScore: obtainedScore,
              percentage: parseFloat(subjectPercentage).toFixed(2),
              grade: grade,
              status: (grade === 'F' || grade === 'D') ? 'Fail' : 'Pass'
            };
            
            subjects.push(subject);
            
            if (subject.status === 'Fail') {
              failedSubjects.push(subjectName);
            }
          }
          
          // Determine overall result status
          var overallStatus = failedSubjects.length > 0 ? 'FAILED' : 'PASSED';
          
          return {
            result: 'success',
            student: studentData,
            subjects: subjects,
            failedSubjects: failedSubjects,
            overallStatus: overallStatus,
            generatedOn: Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd-MMM-yyyy HH:mm")
          };
        }
      }
    }
    
    // If the roll number is not found in any sheet
    return {
      result: 'error',
      message: 'Registration Number Not Found. Please check your registration number and try again.'
    };
    
  } catch (error) {
    Logger.log(`Error: ${error.toString()}`);
    return {
      result: 'error',
      message: 'System Error: Please try again later.'
    };
  }
}

// ==================== HELPER FUNCTIONS ====================

// Format dates for comparison (YYYY-MM-DD format)
function formatDateForComparison(date) {
  if (!date) return "";
  
  if (date instanceof Date) {
    return Utilities.formatDate(date, Session.getScriptTimeZone(), "yyyy-MM-dd");
  }
  
  if (typeof date === 'string') {
    // Try to parse the date
    var parsedDate = new Date(date);
    if (!isNaN(parsedDate.getTime())) {
      return Utilities.formatDate(parsedDate, Session.getScriptTimeZone(), "yyyy-MM-dd");
    }
    
    // Check if already in YYYY-MM-DD format
    if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
      return date;
    }
    
    // Try DD-MM-YYYY format
    if (/^\d{2}-\d{2}-\d{4}$/.test(date)) {
      var parts = date.split('-');
      return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }
    
    // Try DD/MM/YYYY format
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(date)) {
      var parts = date.split('/');
      return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }
  }
  
  return date.toString();
}

// Format dates for display
function formatDateForDisplay(date) {
  if (!date) return "N/A";
  
  if (date instanceof Date) {
    return Utilities.formatDate(date, Session.getScriptTimeZone(), "dd-MMM-yyyy");
  }
  
  if (typeof date === 'string') {
    var parsedDate = new Date(date);
    if (!isNaN(parsedDate.getTime())) {
      return Utilities.formatDate(parsedDate, Session.getScriptTimeZone(), "dd-MMM-yyyy");
    }
    
    // If it's in DD-MM-YYYY format, reformat
    if (/^\d{2}-\d{2}-\d{4}$/.test(date)) {
      var parts = date.split('-');
      var newDate = new Date(parts[2], parts[1]-1, parts[0]);
      return Utilities.formatDate(newDate, Session.getScriptTimeZone(), "dd-MMM-yyyy");
    }
    
    // If it's in YYYY-MM-DD format, reformat
    if (/^\d{4}-\d{2}-\d{2}$/.test(date)) {
      var parts = date.split('-');
      var newDate = new Date(parts[0], parts[1]-1, parts[2]);
      return Utilities.formatDate(newDate, Session.getScriptTimeZone(), "dd-MMM-yyyy");
    }
  }
  
  return date.toString();
}

// Include HTML files
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}
