<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Result Portal - All Classes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 700px;
      margin: 50px auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2 class="text-center mb-4 text-primary">Annual Result Portal</h2>

      <form id="resultForm">
        <div class="mb-3">
          <label class="form-label fw-bold">Registration Number</label>
          <input type="text" class="form-control form-control-lg" 
                 id="roll" placeholder="e.g., r3, r1, etc." required>
        </div>
        
        <div class="mb-4">
          <label class="form-label fw-bold">Date of Birth</label>
          <input type="date" class="form-control form-control-lg" id="dob" required>
        </div>
        
        <button type="submit" class="btn btn-primary btn-lg w-100 py-3">
          Search
        </button>
      </form>
      
      <div id="result" class="mt-4"></div>
    </div>
  </div>

  <script>
    const SHEET_ID = '1ckOFULpgBLG13gWa_jKdy8LJwIUaxCRLN84tljLmCjo';
    
    // Function to get ALL sheet names from the spreadsheet
    async function getAllSheetNames() {
      try {
        // This URL returns sheet names in JSON format
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Failed to fetch sheet list: ${response.status}`);
        }
        
        const text = await response.text();
        
        // Extract JSON from the response
        const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]+)\)/);
        if (!jsonMatch) {
          throw new Error('Invalid response format from Google Sheets');
        }
        
        const data = JSON.parse(jsonMatch[1]);
        
        // Extract sheet names from the response
        const sheetNames = data.table.rows.map(row => row.c[0].v);
        console.log('All sheet names:', sheetNames);
        
        return sheetNames;
        
      } catch (error) {
        console.error('Error getting sheet names:', error);
        
        // Fallback: Try to get sheet names via different method
        try {
          const fallbackUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
          const response = await fetch(fallbackUrl);
          if (response.ok) {
            // If CSV works but JSON doesn't, return common class patterns
            return ['8R', '1A', '2C', '3C', '4C', '5C', '6C', '7C', '9R', '10R'];
          }
        } catch (e) {
          // Return empty if both methods fail
          return [];
        }
        return [];
      }
    }
    
    // Function to get only class sheets (filter out HOME and other non-class sheets)
    async function getClassSheets() {
      const allSheets = await getAllSheetNames();
      
      // Filter to get only class sheets (1A, 2C, 3C, 8R, etc.)
      // Pattern: starts with number, ends with letter OR contains specific patterns
      const classSheets = allSheets.filter(sheetName => {
        // Allow sheets like: 1A, 2B, 3C, 8R, etc.
        // Also allow variations like: VIII-A, IX-B if needed
        return /^\d+[A-Z]$/.test(sheetName) || 
               /^[IVXLCDM]+[-\s]?[A-Z]$/i.test(sheetName) ||
               sheetName === '8R' || 
               sheetName.match(/^Class\s*\d+[A-Z]?$/i) ||
               sheetName.match(/^\d+[A-Z]\d*$/);
      });
      
      console.log('Class sheets found:', classSheets);
      return classSheets;
    }
    
    // Function to fetch data from a specific sheet
    async function fetchSheetData(sheetName) {
      try {
        // Use CSV format for simplicity
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
        const response = await fetch(url);
        
        if (!response.ok) {
          console.warn(`Cannot access sheet "${sheetName}": ${response.status}`);
          return null;
        }
        
        const csvText = await response.text();
        
        // Parse CSV data
        const rows = [];
        const lines = csvText.split('\n');
        
        for (const line of lines) {
          if (line.trim() === '') continue;
          
          const row = parseCSVRow(line);
          if (row.length > 0) {
            rows.push(row);
          }
        }
        
        console.log(`Sheet "${sheetName}" has ${rows.length} rows`);
        return rows;
        
      } catch (error) {
        console.error(`Error fetching sheet "${sheetName}":`, error);
        return null;
      }
    }
    
    // Parse CSV row
    function parseCSVRow(row) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let char of row) {
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }
    
    // Show all sheets in the spreadsheet
    async function showAllSheets() {
      const sheetsInfo = document.getElementById('sheetsInfo');
      sheetsInfo.innerHTML = '<div class="text-center"><div class="loader"></div><p>Loading sheets...</p></div>';
      
      try {
        const allSheets = await getAllSheetNames();
        
        if (allSheets.length === 0) {
          sheetsInfo.innerHTML = `
            <div class="alert alert-danger">
              No sheets found. Please check if the Google Sheet is shared publicly.
            </div>
          `;
          return;
        }
        
        const classSheets = allSheets.filter(sheet => 
          /^\d+[A-Z]$/.test(sheet) || 
          /^[IVXLCDM]+[-\s]?[A-Z]$/i.test(sheet) ||
          sheet === '8R' || 
          sheet.match(/^Class\s*\d+[A-Z]?$/i) ||
          sheet.match(/^\d+[A-Z]\d*$/)
        );
        
        const otherSheets = allSheets.filter(sheet => !classSheets.includes(sheet));
        
        let html = `
          <div class="alert alert-success">
            <h5>✓ Found ${allSheets.length} sheets in total</h5>
        `;
        
        if (classSheets.length > 0) {
          html += `
            <div class="mt-3">
              <h6>Class Sheets (${classSheets.length}):</h6>
              <p><small>These sheets will be searched for student data</small></p>
              <div class="d-flex flex-wrap gap-2">
                ${classSheets.map(sheet => `<span class="badge bg-primary">${sheet}</span>`).join('')}
              </div>
            </div>
          `;
        }
        
        if (otherSheets.length > 0) {
          html += `
            <div class="mt-3">
              <h6>Other Sheets (${otherSheets.length}):</h6>
              <p><small>These sheets will NOT be searched (like HOME, settings, etc.)</small></p>
              <div class="d-flex flex-wrap gap-2">
                ${otherSheets.map(sheet => `<span class="badge bg-secondary">${sheet}</span>`).join('')}
              </div>
            </div>
          `;
        }
        
        html += `</div>`;
        
        sheetsInfo.innerHTML = html;
        
      } catch (error) {
        sheetsInfo.innerHTML = `
          <div class="alert alert-danger">
            Error loading sheets: ${error.message}
          </div>
        `;
      }
    }
    
    // Main search function
    document.getElementById('resultForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const roll = document.getElementById('roll').value.trim();
      const dob = document.getElementById('dob').value;
      
      if (!roll) {
        alert('Please enter registration number');
        return;
      }
      
      // Show loading
      document.getElementById('result').innerHTML = `
        <div class="text-center p-4">
          <div class="loader"></div>
          <h5 class="mt-3">Searching in all classes...</h5>
          <p>Registration: <strong>${roll}</strong></p>
        </div>
      `;
      
      try {
        // Get all class sheets
        const classSheets = await getClassSheets();
        
        if (classSheets.length === 0) {
          throw new Error('No class sheets found. Please check sheet permissions.');
        }
        
        console.log('Searching in sheets:', classSheets);
        
        let found = false;
        let studentData = null;
        let foundSheet = '';
        let sheetDataRows = null;
        
        // Search in each class sheet
        for (const sheetName of classSheets) {
          console.log(`Searching in: ${sheetName}`);
          
          const rows = await fetchSheetData(sheetName);
          if (!rows || rows.length < 2) continue;
          
          // Skip header rows (first 2 rows based on your data structure)
          // Row 0: Class info, Row 1: Column headers
          for (let i = 2; i < rows.length; i++) {
            const row = rows[i];
            
            if (row.length > 0 && row[0]) {
              const regNum = row[0].toString().trim().toLowerCase();
              const searchRoll = roll.toLowerCase();
              
              // Check for exact match or partial match
              if (regNum === searchRoll) {
                // Optional: Verify DOB if provided
                if (dob) {
                  const rowDob = row[1] ? row[1].toString().trim() : '';
                  const searchDob = dob.replace(/-/g, '/');
                  
                  if (rowDob && rowDob !== '' && rowDob !== searchDob && !rowDob.includes(searchDob)) {
                    // DOB doesn't match, continue searching
                    console.log(`DOB mismatch in ${sheetName}: ${rowDob} vs ${searchDob}`);
                    continue;
                  }
                }
                
                found = true;
                studentData = row;
                foundSheet = sheetName;
                sheetDataRows = rows;
                console.log(`Found in ${sheetName}, row ${i}:`, row);
                break;
              }
            }
          }
          
          if (found) break;
        }
        
        // Display result
        if (found && studentData) {
          // Extract data based on your column structure
          const studentInfo = {
            regNo: studentData[0] || 'N/A',
            dob: studentData[1] || 'N/A',
            name: studentData[2] || 'N/A',
            totalMarks: studentData[3] || '0',
            percentage: studentData[4] || '0',
            rank: studentData[5] || '-',
            presents: studentData[6] || '0',
            overallGrade: studentData[7] || 'N/A'
          };
          
          // Get subject names from header row (row 1 in sheet)
          const subjectHeaders = sheetDataRows && sheetDataRows[1] ? 
            sheetDataRows[1].slice(8) : // Subjects start from column 8
            ['التلاوة والحفظ', 'الفقه', 'الصرف', 'العقيدة', 'النحو', 'ENGLISH', 'IT'];
          
          // Extract subject marks (starting from column 8)
          const subjects = [];
          for (let i = 8; i < studentData.length && i - 8 < subjectHeaders.length; i++) {
            subjects.push({
              name: subjectHeaders[i - 8] || `Subject ${i - 7}`,
              marks: studentData[i] || '0',
              max: 50 // Based on your data
            });
          }
          
          // Generate result HTML
          let subjectRows = '';
          let totalSubjects = subjects.length;
          let passedSubjects = 0;
          let failedSubjects = [];
          
          subjects.forEach((subject, index) => {
            const marks = parseFloat(subject.marks) || 0;
            const percentage = (marks / subject.max) * 100;
            const passed = percentage >= 50;
            if (!passed) failedSubjects.push(subject.name);
            if (passed) passedSubjects++;
            
            let grade = '';
            let gradeClass = '';
            if (percentage >= 90) { grade = 'A+'; gradeClass = 'bg-success'; }
            else if (percentage >= 80) { grade = 'A'; gradeClass = 'bg-success'; }
            else if (percentage >= 70) { grade = 'B+'; gradeClass = 'bg-info'; }
            else if (percentage >= 60) { grade = 'B'; gradeClass = 'bg-info'; }
            else if (percentage >= 50) { grade = 'C'; gradeClass = 'bg-warning'; }
            else { grade = 'D'; gradeClass = 'bg-danger'; }
            
            subjectRows += `
              <tr>
                <td>${index + 1}</td>
                <td>${subject.name}</td>
                <td class="text-center">${subject.max}</td>
                <td class="text-center fw-bold">${subject.marks}</td>
                <td class="text-center">${percentage.toFixed(1)}%</td>
                <td class="text-center"><span class="badge ${gradeClass}">${grade}</span></td>
                <td class="text-center ${passed ? 'text-success' : 'text-danger'} fw-bold">${passed ? 'Pass' : 'Fail'}</td>
              </tr>
            `;
          });
          
          const overallResult = passedSubjects === totalSubjects ? 'PASSED' : 'FAILED';
          const overallPercentage = parseFloat(studentInfo.percentage) || 0;
          
          document.getElementById('result').innerHTML = `
            <div class="alert alert-success">
              <h4><i class="fas fa-check-circle"></i> Result Found in ${foundSheet} Class</h4>
            </div>
            
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-user-graduate"></i> Student Information</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <p><strong><i class="fas fa-id-card"></i> Registration No:</strong><br>${studentInfo.regNo.toUpperCase()}</p>
                    <p><strong><i class="fas fa-user"></i> Student Name:</strong><br>${studentInfo.name}</p>
                    <p><strong><i class="fas fa-chalkboard-teacher"></i> Class:</strong><br>${foundSheet}</p>
                  </div>
                  <div class="col-md-6">
                    <p><strong><i class="fas fa-birthday-cake"></i> Date of Birth:</strong><br>${studentInfo.dob}</p>
                    <p><strong><i class="fas fa-chart-bar"></i> Total Marks:</strong><br>${studentInfo.totalMarks}/350</p>
                    <p><strong><i class="fas fa-calendar-check"></i> Attendance:</strong><br>${studentInfo.presents} days</p>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="card mt-3">
              <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-book-open"></i> Subject-wise Performance</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-bordered table-hover">
                    <thead class="table-light">
                      <tr>
                        <th>#</th>
                        <th>Subject</th>
                        <th class="text-center">Max</th>
                        <th class="text-center">Obtained</th>
                        <th class="text-center">%</th>
                        <th class="text-center">Grade</th>
                        <th class="text-center">Status</th>
                      </tr>
                    </thead>
                    <tbody>${subjectRows}</tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <div class="card mt-3 ${overallResult === 'PASSED' ? 'border-success' : 'border-danger'}">
              <div class="card-body text-center">
                <h3 class="${overallResult === 'PASSED' ? 'text-success' : 'text-danger'}">
                  <i class="fas ${overallResult === 'PASSED' ? 'fa-trophy' : 'fa-exclamation-triangle'}"></i>
                  FINAL RESULT: ${overallResult}
                </h3>
                
                ${overallResult === 'FAILED' && failedSubjects.length > 0 ? `
                  <div class="alert alert-danger mt-2">
                    <strong>Failed in ${failedSubjects.length} subject(s):</strong> ${failedSubjects.join(', ')}
                  </div>
                ` : ''}
                
                <div class="row mt-3">
                  <div class="col-md-3 col-6">
                    <div class="p-2 border rounded">
                      <div class="text-muted">Percentage</div>
                      <div class="fs-4 fw-bold">${overallPercentage.toFixed(2)}%</div>
                    </div>
                  </div>
                  <div class="col-md-3 col-6">
                    <div class="p-2 border rounded">
                      <div class="text-muted">Class Rank</div>
                      <div class="fs-4 fw-bold">${studentInfo.rank}</div>
                    </div>
                  </div>
                  <div class="col-md-3 col-6">
                    <div class="p-2 border rounded">
                      <div class="text-muted">Overall Grade</div>
                      <div class="fs-4 fw-bold">${studentInfo.overallGrade}</div>
                    </div>
                  </div>
                  <div class="col-md-3 col-6">
                    <div class="p-2 border rounded">
                      <div class="text-muted">Subjects Passed</div>
                      <div class="fs-4 fw-bold">${passedSubjects}/${totalSubjects}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="text-center mt-4">
              <button onclick="location.reload()" class="btn btn-primary btn-lg">
                <i class="fas fa-redo"></i> Check Another Result
              </button>
              <button onclick="window.print()" class="btn btn-success btn-lg ms-2">
                <i class="fas fa-print"></i> Print Result
              </button>
            </div>
          `;
        } else {
          document.getElementById('result').innerHTML = `
            <div class="alert alert-danger">
              <h4><i class="fas fa-times-circle"></i> Registration Not Found</h4>
              <p>The registration number <strong>"${roll}"</strong> was not found in any class.</p>
              <p>Searched in ${classSheets.length} classes: ${classSheets.join(', ')}</p>
              
              <div class="mt-3">
                <h6>Please check:</h6>
                <ul>
                  <li>Correct spelling of registration number</li>
                  <li>Registration number format (e.g., r2, R2, 101, etc.)</li>
                  <li>Contact examination department for assistance</li>
                </ul>
              </div>
              
              <button onclick="showAllSheets()" class="btn btn-info">
                View Available Sheets
              </button>
              <button onclick="location.reload()" class="btn btn-warning ms-2">
                Try Again
              </button>
            </div>
          `;
        }
        
      } catch (error) {
        document.getElementById('result').innerHTML = `
          <div class="alert alert-danger">
            <h4>System Error</h4>
            <p>${error.message}</p>
            <p>Please try the "Show All Available Sheets" button above to check access.</p>
            <button onclick="location.reload()" class="btn btn-secondary">Retry</button>
          </div>
        `;
      }
    };
    
    // Initialize
    window.onload = function() {
      document.getElementById('roll').focus();
    };
  </script>
</body>
</html>

