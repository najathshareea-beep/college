<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annual Result - Darunnajath College</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    :root { --p:#2563eb; --pd:#1d4ed8; --s:#f59e0b; --ok:#10b981; --no:#ef4444; }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); background-size: 400% 400%; animation: g 15s ease infinite; min-height: 100vh; padding: 20px; }
    @keyframes g { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    .card { background: rgba(255,255,255,0.97); border-radius: 25px; padding: 3rem; max-width: 560px; margin: 40px auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3); text-align:center; }
    .btn-big { background: linear-gradient(135deg, #667eea, #764ba2); border:none; border-radius:15px; padding:1.3rem; color:white; font-size:1.2rem; width:100%; }
    .btn-big:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
    .result-card { background:white; border-radius:15px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.2); margin:20px auto; max-width:960px; }
    .header { background: linear-gradient(135deg,var(--p),var(--pd)); color:white; padding:30px; text-align:center; }
    .header img { width:80px; height:80px; border-radius:15px; border:4px solid rgba(255,255,255,0.4); }
    table { font-size:0.95rem; }
    .grade-pass { background:var(--ok); color:white; padding:4px 10px; border-radius:8px; }
    .grade-fail { background:var(--no); color:white; padding:4px 10px; border-radius:8px; }
    .status-pass { background:#dcfce7; color:#166534; padding:5px 12px; border-radius:20px; }
    .status-fail { background:#fecaca; color:#991b1b; padding:5px 12px; border-radius:20px; }
    .loader { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index:9999; }
    .spinner { width:70px; height:70px; border:8px solid #f3f3f3; border-top:8px solid var(--p); border-radius:50%; animation:s 1s linear infinite; }
    @keyframes s { to { transform:rotate(360deg); } }
    .debug { background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; }
  </style>
</head>
<body>

  <div class="text-center text-white mb-4">
    <h1 style="font-size:3.8rem; font-weight:800; background:linear-gradient(to right,#fff,#f0f0f0); -webkit-background-clip:text; color:transparent;">
      RESULT PORTAL
    </h1>
    <h2>DARUNNAJATH SHAREEATH AND ARTS COLLEGE</h2>
    <p>Punnakkad, Karuvarakundu</p>
  </div>

  <div class="card">
    <h3 style="color:#1e293b;">Annual Examination Result 2025-26</h3>
    <p class="text-muted mt-3">Enter Registration Number & Date of Birth</p>
    <button class="btn-big mt-4" id="openForm">
      <i class="fas fa-search fa-lg"></i> Check Result
    </button>
  </div>

  <div id="resultArea" class="container mt-5" style="display:none;">
    <div id="PrintDiv"><div id="rs"></div></div>
  </div>

  <div class="loader" id="loader">
    <div class="spinner"></div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="fas fa-id-card"></i> Enter Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="myForm">
            <div class="mb-3">
              <label class="form-label">Registration Number</label>
              <input type="text" class="form-control form-control-lg" id="roll" placeholder="e.g. 1001" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Date of Birth</label>
              <input type="date" class="form-control form-control-lg" id="dob" required>
            </div>
            <button type="submit" class="btn btn-primary w-100 btn-lg">Get Result</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const ssid = '1ckOFULpgBLG13gWa_jKdy8LJwIUaxCRLN84tljLmCjo';
    const apikey = 'AIzaSyCEK79A2S8aL3XxQ4mruN1V95ifpDwXNLM';

    document.getElementById('openForm').onclick = () => new bootstrap.Modal(document.getElementById('formModal')).show();

    document.getElementById('myForm').onsubmit = async e => {
      e.preventDefault();
      const roll = document.getElementById('roll').value.trim();
      const dob = document.getElementById('dob').value;
      document.getElementById('loader').style.display = 'flex';
      document.getElementById('rs').innerHTML = '';

      try {
        // Test HOME sheet fetch with debug
        console.log('Fetching HOME sheet...');
        const home = await fetch(`https://docs.google.com/spreadsheets/d/${ssid}/gviz/tq?tqx=out:json&sheet=HOME`);
        if (!home.ok) throw new Error(`HTTP ${home.status}: ${home.statusText}`);
        const ht = await home.text();
        console.log('Raw HOME response preview:', ht.substring(0, 200));  // Debug: Check first 200 chars
        let hj;
        try {
          hj = JSON.parse(ht.replace(/\/\*.*?\*\//g, '').replace(/google\.visualization\.Query\.setResponse\((.*)\);/, '$1'));
        } catch (parseErr) {
          throw new Error(`JSON Parse Error in HOME: ${parseErr.message}. Raw starts with: "${ht.substring(0, 50)}"`);
        }
        const hr = hj.table.rows;
        const collegeName = hr[0]?.c[1]?.v || '';
        const fullName    = hr[1]?.c[1]?.v || '';
        const place       = hr[2]?.c[1]?.v || '';
        const examTitle   = hr[3]?.c[1]?.v || '';

        // Get all class sheets
        console.log('Fetching sheet list...');
        const sheets = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${ssid}?key=${apikey}`);
        if (!sheets.ok) throw new Error(`Sheet list error: HTTP ${sheets.status}`);
        const sdata = await sheets.json();
        const classSheets = sdata.sheets.map(s=>s.properties.title).filter(t=>/^\d+[A-Z]$/.test(t));
        console.log('Class sheets found:', classSheets);  // Debug

        if (classSheets.length === 0) throw new Error('No class sheets found (e.g., 1A, 2B). Check sheet names.');

        let found = false;
        for (const sh of classSheets) {
          console.log(`Searching in sheet: ${sh}`);
          const url = `https://docs.google.com/spreadsheets/d/${ssid}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sh)}&tq=SELECT%20*%20WHERE%20A%3D%27${roll}%27`;
          const res = await fetch(url);
          if (!res.ok) {
            console.log(`Fetch failed for ${sh}: ${res.status}`);
            continue;
          }
          const txt = await res.text();
          console.log(`Raw response preview for ${sh}:`, txt.substring(0, 200));  // Debug
          let js;
          try {
            js = JSON.parse(txt.replace(/\/\*.*?\*\//g, '').replace(/google\.visualization\.Query\.setResponse\((.*)\);/, '$1'));
          } catch (parseErr) {
            console.log(`Parse error for ${sh}: ${parseErr.message}`);
            continue;
          }
          if (!js.table || !js.table.rows || js.table.rows.length === 0) continue;

          const row = js.table.rows[0].c;
          const dobSheet = row[1] ? new Date(row[1].v).toISOString().slice(0,10) : '';
          if (dobSheet !== dob) throw new Error('Invalid Date of Birth');

          // Header (first 2 rows)
          const hurl = `https://docs.google.com/spreadsheets/d/${ssid}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sh)}&tq=SELECT%20*%20LIMIT%202`;
          const hres = await fetch(hurl);
          const htxt = await hres.text();
          const hjs = JSON.parse(htxt.replace(/\/\*.*?\*\//g, '').replace(/google\.visualization\.Query\.setResponse\((.*)\);/, '$1'));
          const [hrow, subjRow] = hjs.table.rows.map(r=>r.c);

          const className = hrow[1]?.v || '';
          const totalMax = hrow[6]?.v || 0;
          const name = row[2]?.v || '';
          const totalObt = row[3]?.v || 0;
          const perc = parseFloat(row[4]?.v || 0).toFixed(2);
          const rank = row[5]?.v || '';
          const oGrade = row[7]?.v || '';

          const subjects = subjRow.slice(8,37).map(c=>c?.v||'');
          const maxM = hrow.slice(8,37).map(c=>c?.v||0);
          const obtM = row.slice(8,37).map(c=>c?.v ?? c?.f ?? '');

          let tr = '', failed=[], no=1;
          for(let i=0;i<subjects.length;i++){
            if(!subjects[i]) continue;
            let g = 'N/A';
            if(obtM[i]!=='A'){
              const p = (obtM[i]/maxM[i])*100;
              if(p>=90) g='A+'; else if(p>=80) g='A'; else if(p>=70) g='B+'; else if(p>=60) g='B'; else if(p>=50) g='C'; else g='D';
            } else g='D';
            if(g==='D') failed.push(subjects[i]);
            tr += `<tr><td>${no++}</td><td>${subjects[i]}</td><td>${maxM[i]}</td><td>${obtM[i]}</td><td class="${g==='D'?'grade-fail':'grade-pass'}">${g}</td><td><span class="status-${g==='D'?'fail':'pass'}">${g==='D'?'Fail':'Pass'}</span></td></tr>`;
          }

          const status = failed.length ? 'FAILED' : 'PASSED';
          const now = new Date().toLocaleString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});

          document.getElementById('rs').innerHTML = `
            <div class="text-center mb-4">
              <button onclick="location.reload()" class="btn btn-warning"><i class="fas fa-arrow-left"></i> Check Another</button>
              <button onclick="window.print()" class="btn btn-success ms-3"><i class="fas fa-print"></i> Print</button>
            </div>
            <div class="result-card">
              <div class="header">
                <div class="d-flex justify-content-center align-items-center gap-4">
                  <img src="https://i.postimg.cc/rmS5jXXX/COLLEGE-LOGO.png" alt="logo">
                  <div class="text-start">
                    <h1>${collegeName}</h1>
                    <h2>${fullName}</h2>
                    <h3>${place}</h3>
                    <div style="background:rgba(255,255,255,0.3);padding:8px 20px;border-radius:30px;display:inline-block;margin-top:10px;">${examTitle}</div>
                  </div>
                </div>
              </div>
              <div class="p-4">
                <h4 class="text-primary mb-4">Student Information</h4>
                <div class="row text-center">
                  <div class="col-6 col-md-3"><strong>Reg No:</strong> ${roll}</div>
                  <div class="col-6 col-md-3"><strong>Name:</strong> ${name}</div>
                  <div class="col-6 col-md-3"><strong>Class:</strong> ${className}</div>
                  <div class="col-6 col-md-3"><strong>DOB:</strong> ${dob.split('-').reverse().join('-')}</div>
                </div>
                <h4 class="text-primary mt-5 mb-3">Subject-wise Marks</h4>
                <div class="table-responsive">
                  <table class="table table-bordered modern-table"><thead class="table-primary"><tr><th>#</th><th>Subject</th><th>Max</th><th>Obtained</th><th>Grade</th><th>Status</th></tr></thead><tbody>${tr}</tbody></table>
                </div>
                <div class="mt-5 text-center ${failed.length?'text-danger':'text-success'} fs-3">
                  <strong>${status}</strong> ${failed.length?`<br>Failed in: ${failed.join(', ')}`:''}
                </div>
                <div class="mt-4 row text-center">
                  <div class="col-6 col-md-3"><strong>Total:</strong> ${totalObt}/${totalMax}</div>
                  <div class="col-6 col-md-3"><strong>Percentage:</strong> ${perc}%</div>
                  <div class="col-6 col-md-3"><strong>Grade:</strong> ${oGrade}</div>
                  <div class="col-6 col-md-3"><strong>Rank:</strong> ${rank}</div>
                </div>
                <div class="text-center text-muted mt-4">Generated: ${now}</div>
              </div>
            </div>
          `;

          found = true; break;
        }
        if(!found) throw new Error('Registration number not found');

        document.getElementById('resultArea').style.display = 'block';
        bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();

      } catch(err) {
        console.error('Full error:', err);  // Debug in console
        document.getElementById('rs').innerHTML = `
          <div class="text-center p-5 bg-white rounded shadow">
            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
            <h3>${err.message}</h3>
            <p>Check browser console (F12) for details. Sheet may need full public sharing.</p>
            <div class="debug">Error: ${err.message}</div>
            <button onclick="location.reload()" class="btn btn-warning mt-3">Try Again</button>
          </div>`;
        document.getElementById('resultArea').style.display = 'block';
      } finally {
        document.getElementById('loader').style.display = 'none';
      }
    };
  </script>
</body>
</html>
