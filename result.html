<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annual Result - Darunnajath College</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); background-size: 400% 400%; animation: g 15s ease infinite; min-height: 100vh; padding: 20px; }
    @keyframes g { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    .card { background: rgba(255,255,255,0.97); border-radius: 25px; padding: 3rem; max-width: 560px; margin: 40px auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3); text-align:center; }
    .btn-big { background: linear-gradient(135deg, #667eea, #764ba2); border:none; border-radius:15px; padding:1.3rem; color:white; font-size:1.2rem; width:100%; }
    .btn-big:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
    .result-card { background:white; border-radius:15px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.2); margin:20px auto; max-width:960px; }
    .header { background: linear-gradient(135deg,#2563eb,#1d4ed8); color:white; padding:30px; text-align:center; }
    .header img { width:80px; height:80px; border-radius:15px; border:4px solid rgba(255,255,255,0.4); }
    table { font-size:0.95rem; }
    .grade-pass { background:#10b981; color:white; padding:4px 10px; border-radius:8px; }
    .grade-fail { background:#ef4444; color:white; padding:4px 10px; border-radius:8px; }
    .status-pass { background:#dcfce7; color:#166534; padding:5px 12px; border-radius:20px; }
    .status-fail { background:#fecaca; color:#991b1b; padding:5px 12px; border-radius:20px; }
    .loader { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index:9999; }
    .spinner { width:70px; height:70px; border:8px solid #f3f3f3; border-top:8px solid #2563eb; border-radius:50%; animation:s 1s linear infinite; }
    @keyframes s { to { transform:rotate(360deg); } }
  </style>
</head>
<body>

  <div class="text-center text-white mb-4">
    <h1 style="font-size:3.8rem; font-weight:800; background:linear-gradient(to right,#fff,#f0f0f0); -webkit-background-clip:text; color:transparent;">
      RESULT PORTAL
    </h1>
    <h2>DARUNNAJATH SHAREEATH AND ARTS COLLEGE</h2>
    <p>Punnakkad, Karuvarakundu</p>
  </div>

  <div class="card">
    <h3 style="color:#1e293b;">Annual Examination Result 2025-26</h3>
    <p class="text-muted mt-3">Enter Registration Number & Date of Birth</p>
    <button class="btn-big mt-4" id="openForm">
      Check Result
    </button>
  </div>

  <div id="resultArea" class="container mt-5" style="display:none;">
    <div id="PrintDiv"><div id="rs"></div></div>
  </div>

  <div class="loader" id="loader">
    <div class="spinner"></div>
  </div>

  <div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Enter Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="myForm">
            <div class="mb-3">
              <label class="form-label">Registration Number</label>
              <input type="text" class="form-control form-control-lg" id="roll" placeholder="e.g. r1" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Date of Birth</label>
              <input type="date" class="form-control form-control-lg" id="dob" required>
            </div>
            <button type="submit" class="btn btn-primary w-100 btn-lg">Get Result</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const ssid = '1ckOFULpgBLG13gWa_jKdy8LJwIUaxCRLN84tljLmCjo';
    const apikey = 'AIzaSyCEK79A2S8aL3XxQ4mruN1V95ifpDwXNLM';

    document.getElementById('openForm').onclick = () => new bootstrap.Modal(document.getElementById('formModal')).show();

    document.getElementById('myForm').onsubmit = async e => {
      e.preventDefault();
      const inputRoll = document.getElementById('roll').value.trim().toLowerCase();  // Force lowercase
      const inputDob = document.getElementById('dob').value;
      document.getElementById('loader').style.display = 'flex';
      document.getElementById('rs').innerHTML = '';

      try {
        const sheetsRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${ssid}?key=${apikey}`);
        const sheetsData = await sheetsRes.json();
        const sheetNames = sheetsData.sheets.map(s => s.properties.title).filter(n => n !== 'HOME');

        let found = false;
        for (const sheet of sheetNames) {
          const url = `https://docs.google.com/spreadsheets/d/${ssid}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}`;
          const res = await fetch(url);
          const text = await res.text();
          const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?$/);
          if (!jsonMatch) continue;
          const json = JSON.parse(jsonMatch[1]);
          const rows = json.table.rows;

          for (let i = 2; i < rows.length; i++) {
            const c = rows[i].c;
            if (!c || !c[0]) continue;
            const sheetRoll = (c[0].v || '').toString().trim().toLowerCase();  // Force lowercase
            if (sheetRoll !== inputRoll) continue;

            const sheetDob = c[1]?.v ? new Date(c[1].v).toISOString().slice(0,10) : '';
            if (sheetDob !== inputDob) throw new Error('Invalid Date of Birth');

            const name = c[2]?.v || 'N/A';
            const total = c[3]?.v || 0;
            const perc = parseFloat(c[4]?.v || 0).toFixed(2);
            const rank = c[5]?.v || '-';
            const grade = c[7]?.v || '-';

            const subjRow = rows[1].c.slice(8);
            const maxRow = rows[0].c.slice(8);
            const obtRow = c.slice(8);

            let tr = '', failed = [], no = 1;
            for (let j = 0; j < subjRow.length; j++) {
              if (!subjRow[j]?.v) continue;
              const subj = subjRow[j].v;
              const max = maxRow[j]?.v || 50;
              const obt = obtRow[j]?.v ?? obtRow[j]?.f ?? 'A';
              let g = 'N/A';
              if (obt !== 'A') {
                const p = (obt / max) * 100;
                if (p >= 90) g = 'A+'; else if (p >= 80) g = 'A'; else if (p >= 70) g = 'B+';
                else if (p >= 60) g = 'B'; else if (p >= 50) g = 'C'; else g = 'D';
              } else g = 'D';
              if (g === 'D') failed.push(subj);
              tr += `<tr><td>${no++}</td><td>${subj}</td><td>${max}</td><td>${obt}</td><td class="${g==='D'?'grade-fail':'grade-pass'}">${g}</td><td><span class="status-${g==='D'?'fail':'pass'}">${g==='D'?'Fail':'Pass'}</span></td></tr>`;
            }

            const status = failed.length > 0 ? 'FAILED' : 'PASSED';
            const now = new Date().toLocaleString('en-GB', {day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'});

            document.getElementById('rs').innerHTML = `
              <div class="text-center mb-4">
                <button onclick="location.reload()" class="btn btn-warning">Check Another</button>
                <button onclick="window.print()" class="btn btn-success ms-3">Print</button>
              </div>
              <div class="result-card">
                <div class="header">
                  <div class="d-flex justify-content-center align-items-center gap-4">
                    <img src="https://i.postimg.cc/rmS5jXXX/COLLEGE-LOGO.png" alt="logo">
                    <div class="text-start">
                      <h1>DARUNNAJATH SHAREEATH COLLEGE</h1>
                      <h2>Karuvarakundu</h2>
                      <div style="background:rgba(255,255,255,0.3);padding:8px 20px;border-radius:30px;display:inline-block;margin-top:10px;">Annual Examination 2025-26</div>
                    </div>
                  </div>
                </div>
                <div class="p-4">
                  <h4 class="text-primary mb-4">Student Information</h4>
                  <div class="row text-center mb-4">
                    <div class="col-6 col-md-3"><strong>Reg No:</strong> ${inputRoll.toUpperCase()}</div>
                    <div class="col-6 col-md-3"><strong>Name:</strong> ${name}</div>
                    <div class="col-6 col-md-3"><strong>Class:</strong> ${sheet}</div>
                    <div class="col-6 col-md-3"><strong>DOB:</strong> ${inputDob.split('-').reverse().join('-')}</div>
                  </div>
                  <h4 class="text-primary mb-3">Subject-wise Performance</h4>
                  <div class="table-responsive">
                    <table class="table table-bordered"><thead class="table-primary"><tr><th>#</th><th>Subject</th><th>Max</th><th>Obtained</th><th>Grade</th><th>Status</th></tr></thead><tbody>${tr}</tbody></table>
                  </div>
                  <div class="mt-4 text-center ${failed.length?'text-danger':'text-success'} fs-3"><strong>${status}</strong></div>
                  ${failed.length ? `<p class="text-danger text-center">Failed in: ${failed.join(', ')}</p>` : ''}
                  <div class="row text-center mt-4">
                    <div class="col-6 col-md-3"><strong>Total:</strong> ${total}</div>
                    <div class="col-6 col-md-3"><strong>Percentage:</strong> ${perc}%</div>
                    <div class="col-6 col-md-3"><strong>Overall Grade:</strong> ${grade}</div>
                    <div class="col-6 col-md-3"><strong>Rank:</strong> ${rank}</div>
                  </div>
                  <div class="text-center text-muted mt-4">Generated: ${now}</div>
                </div>
              </div>
            `;

            found = true;
            break;
          }
          if (found) break;
        }
        if (!found) throw new Error('Registration number not found');

        document.getElementById('resultArea').style.display = 'block';
        bootstrap.Modal.getInstance(document.getElementById('formModal')).hide();

      } catch (err) {
        document.getElementById('rs').innerHTML = `
          <div class="text-center p-5 bg-white rounded shadow">
            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
            <h3>${err.message}</h3>
            <button onclick="location.reload()" class="btn btn-warning mt-3">Try Again</button>
          </div>`;
        document.getElementById('resultArea').style.display = 'block';
      } finally {
        document.getElementById('loader').style.display = 'none';
      }
    };
  </script>
</body>
</html>
