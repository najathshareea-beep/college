<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Result Portal - Darunnajath College</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      margin: 50px auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .result-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2 class="text-center mb-4">Annual Result 2025-26</h2>
      <h5 class="text-center text-muted mb-4">Darunnajath Shareeath College</h5>
      
      <form id="resultForm">
        <div class="mb-3">
          <label class="form-label">Registration Number</label>
          <input type="text" class="form-control form-control-lg" 
                 id="roll" placeholder="Enter registration number" required>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Date of Birth</label>
          <input type="date" class="form-control form-control-lg" id="dob" required>
        </div>
        
        <button type="submit" class="btn btn-primary btn-lg w-100">
          Get Result
        </button>
      </form>
      
      <div id="result" class="mt-4"></div>
    </div>
  </div>

  <script>
    // Your Google Sheet ID
    const SHEET_ID = '1ckOFULpgBLG13gWa_jKdy8LJwIUaxCRLN84tljLmCjo';
    
    document.getElementById('resultForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const roll = document.getElementById('roll').value.trim();
      const dob = document.getElementById('dob').value;
      
      // Show loading
      document.getElementById('result').innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary"></div>
          <p>Loading...</p>
        </div>
      `;
      
      try {
        // IMPORTANT: This URL works for PUBLIC Google Sheets
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
        
        console.log('Fetching from:', url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Failed to fetch data. Status: ${response.status}`);
        }
        
        const csvText = await response.text();
        console.log('Raw CSV data (first 500 chars):', csvText.substring(0, 500));
        
        // Parse CSV
        const rows = csvText.split('\n').map(row => {
          // Simple CSV parsing
          const result = [];
          let current = '';
          let inQuotes = false;
          
          for (let char of row) {
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              result.push(current);
              current = '';
            } else {
              current += char;
            }
          }
          result.push(current);
          return result;
        });
        
        console.log('Parsed rows:', rows);
        
        // Search for registration number
        let foundRow = null;
        
        for (let i = 0; i < rows.length; i++) {
          if (rows[i].length > 0) {
            const regNum = rows[i][0] ? rows[i][0].toString().trim().toLowerCase() : '';
            const searchRoll = roll.toLowerCase();
            
            if (regNum === searchRoll) {
              foundRow = rows[i];
              console.log('Found at row:', i, foundRow);
              break;
            }
          }
        }
        
        // Display result
        if (foundRow) {
          // Assuming columns: [RegNo, DOB, Name, Total, Percentage, Rank, Class, Grade, ...subjects]
          const studentData = {
            reg: foundRow[0] || 'N/A',
            dob: foundRow[1] || 'N/A',
            name: foundRow[2] || 'N/A',
            total: foundRow[3] || '0',
            percentage: foundRow[4] || '0',
            rank: foundRow[5] || '-',
            className: foundRow[6] || '-',
            grade: foundRow[7] || '-'
          };
          
          document.getElementById('result').innerHTML = `
            <div class="result-card">
              <div class="alert alert-success">
                <h4>âœ“ Result Found!</h4>
              </div>
              
              <table class="table">
                <tr><th>Registration No:</th><td>${studentData.reg}</td></tr>
                <tr><th>Student Name:</th><td>${studentData.name}</td></tr>
                <tr><th>Date of Birth:</th><td>${studentData.dob}</td></tr>
                <tr><th>Class:</th><td>${studentData.className}</td></tr>
                <tr><th>Total Marks:</th><td>${studentData.total}</td></tr>
                <tr><th>Percentage:</th><td>${studentData.percentage}%</td></tr>
                <tr><th>Grade:</th><td><span class="badge bg-success">${studentData.grade}</span></td></tr>
                <tr><th>Rank:</th><td>${studentData.rank}</td></tr>
              </table>
              
              <div class="text-center">
                <button onclick="location.reload()" class="btn btn-primary">Check Another</button>
                <button onclick="window.print()" class="btn btn-success ms-2">Print</button>
              </div>
            </div>
          `;
        } else {
          document.getElementById('result').innerHTML = `
            <div class="alert alert-danger">
              <h4>Registration Not Found</h4>
              <p>The registration number <strong>${roll}</strong> was not found.</p>
              <p>Available registration numbers in sheet:</p>
              <div style="max-height: 100px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                ${rows.slice(0, 10).map((row, i) => 
                  `<small>${i}: ${row[0] || 'empty'}</small><br>`
                ).join('')}
              </div>
              <button onclick="location.reload()" class="btn btn-warning mt-3">Try Again</button>
            </div>
          `;
        }
        
      } catch (error) {
        document.getElementById('result').innerHTML = `
          <div class="alert alert-danger">
            <h4>Error</h4>
            <p>${error.message}</p>
            <p>Make sure your Google Sheet is shared publicly:</p>
            <ol>
              <li>Open your Google Sheet</li>
              <li>Click "Share" button</li>
              <li>Click "Change to anyone with the link"</li>
              <li>Select "Viewer"</li>
              <li>Click "Done"</li>
            </ol>
            <button onclick="location.reload()" class="btn btn-secondary">Retry</button>
          </div>
        `;
      }
    };
  </script>
</body>
</html>
